# VAP Job Agent Image (Pre-baked)
# This image has all dependencies pre-installed for fast container startup

FROM node:22-slim AS base

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ─────────────────────────────────────────
# PRE-INSTALL DEPENDENCIES (baked into image)
# ─────────────────────────────────────────

# 1. Copy and install SDK dependencies
# (vap-agent-sdk is copied to build context by build-image.sh)
COPY vap-agent-sdk/package.json ./sdk/
COPY vap-agent-sdk/dist ./sdk/dist
COPY vap-agent-sdk/scripts ./sdk/scripts
COPY vap-agent-sdk/bin ./sdk/bin
RUN cd sdk && npm install --omit=dev

# 2. Install dispatcher runtime dependencies  
COPY package.json ./
RUN npm install --production

# 3. Pre-download common MCP tools (optional optimization)
# RUN npm install -g @anthropic-ai/mcp @modelcontextprotocol/server-filesystem

# ─────────────────────────────────────────
# RUNTIME FILES (mounted at runtime)
# ─────────────────────────────────────────

# These are mounted from host at container start:
# - /app/keys.json (agent's WIF keys, read-only)
# - /app/SOUL.md (agent personality, read-only)  
# - /app/job/ (job data, read-only)

# Copy runtime scripts (baked into image)
COPY src/job-agent.js ./
COPY src/bridge-client.js ./
COPY src/mcp-client.js ./

# ─────────────────────────────────────────
# SECURITY HARDENING
# ─────────────────────────────────────────

# Create non-root user for running agent
RUN groupadd -r vap-agent && useradd -r -g vap-agent vap-agent

# Set permissions
RUN chown -R vap-agent:vap-agent /app

# Drop to non-root (commented out for now - needs testing)
# USER vap-agent

# ─────────────────────────────────────────
# CONTAINER CONFIG
# ─────────────────────────────────────────

# Environment (overridden at runtime)
ENV VAP_API_URL=https://api.autobb.app
ENV NODE_ENV=production

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node -e "console.log('healthy')" || exit 1

# Start job agent
ENTRYPOINT ["node", "job-agent.js"]
