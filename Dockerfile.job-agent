# VAP Job Agent Image (Pre-baked)
# This image has all dependencies pre-installed for fast container startup

FROM node:22-slim AS base

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ─────────────────────────────────────────
# PRE-INSTALL DEPENDENCIES (baked into image)
# ─────────────────────────────────────────

# 1. Copy SDK dependencies (pre-installed on host)
# (vap-agent-sdk is copied to build context by build-image.sh)
COPY vap-agent-sdk/package.json ./sdk/
COPY vap-agent-sdk/dist ./sdk/dist
COPY vap-agent-sdk/scripts ./sdk/scripts
COPY vap-agent-sdk/bin ./sdk/bin
COPY vap-agent-sdk/node_modules ./sdk/node_modules

# Run postinstall for bitcoin-ops patch
RUN cd sdk && node scripts/postinstall.js

# 2. Install dispatcher runtime dependencies with pnpm
COPY package.json ./
RUN corepack enable && corepack prepare pnpm@latest --activate && pnpm install --prod

# 3. Pre-download common MCP tools (optional optimization)
# RUN pnpm install -g @anthropic-ai/mcp @modelcontextprotocol/server-filesystem

# ─────────────────────────────────────────
# RUNTIME FILES (mounted at runtime)
# ─────────────────────────────────────────

# These are mounted from host at container start:
# - /app/keys.json (agent's WIF keys, read-only)
# - /app/SOUL.md (agent personality, read-only)  
# - /app/job/ (job data, read-only)

# Copy runtime scripts (baked into image)
COPY src/job-agent.js ./
COPY src/bridge-client.js ./
COPY src/mcp-client.js ./

# ─────────────────────────────────────────
# SECURITY HARDENING
# ─────────────────────────────────────────

# Create non-root user for running agent
RUN groupadd -r vap-agent && useradd -r -g vap-agent vap-agent

# Set permissions
RUN chown -R vap-agent:vap-agent /app

# Drop to non-root
USER vap-agent

# ─────────────────────────────────────────
# CONTAINER CONFIG
# ─────────────────────────────────────────

# Environment (overridden at runtime)
ENV VAP_API_URL=https://api.autobb.app
ENV NODE_ENV=production

# Health check — verify Node process is responsive
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
  CMD node -e "setTimeout(() => { process.exit(0); }, 1000).unref();" || exit 1

# Start job agent
ENTRYPOINT ["node", "job-agent.js"]
